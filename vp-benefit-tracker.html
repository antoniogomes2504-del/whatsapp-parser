<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VP Benefit Tracker ‚Äî Controle de Benef√≠cio de Viagens</title>
    <meta name="description"
        content="Gerencie o benef√≠cio anual de viagens de VPs com IA. Interpreta conversas WhatsApp e gera dashboards e relat√≥rios Excel." />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vp-bg': '#0F1923',
                        'vp-card': '#1A2535',
                        'vp-green': '#25D366',
                        'vp-green-dark': '#075E54',
                        'vp-teal': '#128C7E',
                        'vp-text': '#FFFFFF',
                        'vp-sub': '#8A9BB0',
                        'vp-warn': '#F59E0B',
                        'vp-danger': '#EF4444',
                        'vp-excel': '#1D6F42',
                    },
                    fontFamily: { inter: ['Inter', 'Segoe UI', 'sans-serif'] },
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #0F1923;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: #FFF;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes borderDash {
            0% {
                background-position: 0 0, 100% 0, 100% 100%, 0 100%
            }

            100% {
                background-position: 100% 0, 100% 100%, 0 100%, 0 0
            }
        }

        .drop-border {
            background-image: linear-gradient(90deg, #25D366 50%, transparent 50%), linear-gradient(0deg, #25D366 50%, transparent 50%), linear-gradient(90deg, #25D366 50%, transparent 50%), linear-gradient(0deg, #25D366 50%, transparent 50%);
            background-size: 20px 2px, 2px 20px, 20px 2px, 2px 20px;
            background-position: 0 0, 100% 0, 100% 100%, 0 100%;
            background-repeat: no-repeat;
            animation: borderDash 8s linear infinite;
            padding: 2px;
            border-radius: 14px;
        }

        .drop-border.dragging {
            animation: borderDash 1s linear infinite;
            background-image: linear-gradient(90deg, #25D366 70%, transparent 30%), linear-gradient(0deg, #25D366 70%, transparent 30%), linear-gradient(90deg, #25D366 70%, transparent 30%), linear-gradient(0deg, #25D366 70%, transparent 30%);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%)
            }

            100% {
                transform: translateX(100%)
            }
        }

        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .25), transparent);
            animation: shimmer 1.5s infinite
        }

        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(24px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .anim-up {
            animation: fadeUp .5s ease-out forwards
        }

        @keyframes pulse-danger {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, .4)
            }

            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0)
            }
        }

        .pulse-danger {
            animation: pulse-danger 2s infinite
        }

        @keyframes pulse-green {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, .4)
            }

            50% {
                box-shadow: 0 0 0 12px rgba(37, 211, 102, 0)
            }
        }

        .pulse-green {
            animation: pulse-green 2.5s infinite
        }

        @keyframes toastIn {
            0% {
                transform: translateX(120%);
                opacity: 0
            }

            100% {
                transform: translateX(0);
                opacity: 1
            }
        }

        @keyframes toastOut {
            0% {
                transform: translateX(0);
                opacity: 1
            }

            100% {
                transform: translateX(120%);
                opacity: 0
            }
        }

        .toast-in {
            animation: toastIn .4s ease-out forwards
        }

        .toast-out {
            animation: toastOut .4s ease-in forwards
        }

        .glass {
            background: rgba(26, 37, 53, .7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(37, 211, 102, .1)
        }

        ::-webkit-scrollbar {
            width: 6px
        }

        ::-webkit-scrollbar-track {
            background: #0F1923
        }

        ::-webkit-scrollbar-thumb {
            background: #128C7E;
            border-radius: 3px
        }

        .rotate-icon {
            transition: transform .3s ease
        }

        .rotate-icon.open {
            transform: rotate(180deg)
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect, useMemo } = React;

        /* ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ */
        const BUDGET = 60000;
        const VP_COLORS = ['#25D366', '#3B82F6', '#F59E0B', '#8B5CF6', '#F97316', '#EC4899', '#14B8A6', '#6366F1'];
        const ROW_COLORS = ['D4EDDA', 'CCE5FF', 'FFF3CD', 'E8DAEF', 'FFE0CC', 'FCE4EC', 'D1F2EB', 'DBEAFE'];
        const TYPE_CONFIG = {
            uso: { emoji: 'üü¢', label: 'Uso', color: '#25D366', bg: 'rgba(37,211,102,.12)' },
            saldo: { emoji: 'üîµ', label: 'Saldo', color: '#3B82F6', bg: 'rgba(59,130,246,.12)' },
            reembolso: { emoji: 'üü°', label: 'Reembolso', color: '#F59E0B', bg: 'rgba(245,158,11,.12)' },
            cancelamento: { emoji: 'üî¥', label: 'Cancelamento', color: '#EF4444', bg: 'rgba(239,68,68,.12)' },
        };

        /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
        function Toast({ msg, visible, onHide }) {
            const [leaving, setLeaving] = useState(false);
            useEffect(() => { if (visible) { setLeaving(false); const t = setTimeout(() => { setLeaving(true); setTimeout(onHide, 400) }, 3000); return () => clearTimeout(t) } }, [visible, onHide]);
            if (!visible && !leaving) return null;
            return (<div className={`fixed bottom-6 right-6 z-50 flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl ${leaving ? 'toast-out' : 'toast-in'}`} style={{ background: 'linear-gradient(135deg,#1D6F42,#25D366)' }}><span className="text-xl">‚úÖ</span><span className="text-white font-semibold text-sm">{msg}</span></div>);
        }

        /* ‚îÄ‚îÄ‚îÄ Status badge ‚îÄ‚îÄ‚îÄ */
        function StatusBadge({ pct }) {
            if (pct > 90) return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-500/20 text-red-400 border border-red-500/30">üö® Cr√≠tico</span>;
            if (pct >= 70) return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">‚ö†Ô∏è Aten√ß√£o</span>;
            return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-green-500/20 text-green-400 border border-green-500/30">‚úÖ Normal</span>;
        }

        /* ‚îÄ‚îÄ‚îÄ Usage bar ‚îÄ‚îÄ‚îÄ */
        function UsageBar({ pct }) {
            const clp = Math.min(pct, 100);
            const color = pct > 90 ? '#EF4444' : pct >= 70 ? '#F59E0B' : '#25D366';
            return (
                <div className="w-full h-3 rounded-full overflow-hidden bg-white/5 mt-2">
                    <div className="h-full rounded-full transition-all duration-700 relative" style={{ width: `${clp}%`, background: color }}>
                        {pct > 90 && <div className="absolute inset-0 rounded-full pulse-danger" style={{ background: color }} />}
                    </div>
                </div>
            );
        }

        /* ‚îÄ‚îÄ‚îÄ VP Card ‚îÄ‚îÄ‚îÄ */
        function VPCard({ vp, events, colorIdx }) {
            const [open, setOpen] = useState(false);
            const color = VP_COLORS[colorIdx % VP_COLORS.length];

            /* Calculate financials */
            const saldoEvents = events.filter(e => e.tipo === 'saldo');
            const usoEvents = events.filter(e => e.tipo === 'uso' || e.tipo === 'cancelamento');
            const reembolsoEvents = events.filter(e => e.tipo === 'reembolso');

            let gasto, disponivel;
            if (saldoEvents.length > 0) {
                const lastSaldo = saldoEvents[saldoEvents.length - 1];
                disponivel = lastSaldo.valor;
                gasto = BUDGET - disponivel;
            } else {
                const totalUso = usoEvents.reduce((s, e) => s + Math.abs(e.valor || 0), 0);
                const totalReembolso = reembolsoEvents.reduce((s, e) => s + Math.abs(e.valor || 0), 0);
                gasto = totalUso - totalReembolso;
                disponivel = BUDGET - gasto;
            }
            if (gasto < 0) gasto = 0;
            if (disponivel < 0) disponivel = 0;
            const pct = Math.round((gasto / BUDGET) * 100);
            const isCritical = disponivel < 5000;

            return (
                <div className={`glass rounded-2xl overflow-hidden shadow-xl anim-up ${isCritical ? 'border-red-500/40' : ''}`} style={{ animationDelay: `${colorIdx * 0.1}s`, borderColor: isCritical ? undefined : 'rgba(255,255,255,.06)' }}>
                    {/* Header stripe */}
                    <div className="h-1" style={{ background: `linear-gradient(90deg,${color},${color}88)` }} />

                    <div className="p-5 sm:p-6">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" style={{ background: color + '22', color }}>
                                    {vp.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="text-white font-bold text-base">{vp}</h3>
                                    <p className="text-vp-sub text-xs">{events.length} evento{events.length !== 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <StatusBadge pct={pct} />
                        </div>

                        {/* Financials */}
                        <div className="grid grid-cols-3 gap-3 mb-3">
                            <div className="bg-white/5 rounded-lg p-3 text-center">
                                <p className="text-[10px] text-vp-sub font-semibold uppercase">Or√ßado</p>
                                <p className="text-sm font-bold text-white mt-1">R$ {BUDGET.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                            </div>
                            <div className="bg-white/5 rounded-lg p-3 text-center">
                                <p className="text-[10px] text-vp-sub font-semibold uppercase">Gasto</p>
                                <p className="text-sm font-bold mt-1" style={{ color }}>{`R$ ${gasto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`}</p>
                            </div>
                            <div className={`rounded-lg p-3 text-center ${isCritical ? 'bg-red-500/10' : 'bg-white/5'}`}>
                                <p className="text-[10px] text-vp-sub font-semibold uppercase">Dispon√≠vel</p>
                                <p className={`text-sm font-bold mt-1 ${isCritical ? 'text-red-400' : 'text-green-400'}`}>R$ {disponivel.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                            </div>
                        </div>

                        <div className="flex items-center justify-between text-xs text-vp-sub">
                            <span>{pct}% utilizado</span>
                            {isCritical && <span className="text-red-400 font-semibold">‚ö† Saldo baixo</span>}
                        </div>
                        <UsageBar pct={pct} />

                        {/* Last event */}
                        {events.length > 0 && (
                            <p className="text-vp-sub text-xs mt-3 truncate">
                                √öltima mov.: <span className="text-white/80">{events[events.length - 1].descricao}</span>
                            </p>
                        )}

                        {/* Toggle details */}
                        <button onClick={() => setOpen(!open)} className="mt-4 flex items-center gap-1.5 text-xs font-semibold transition-colors hover:text-vp-green" style={{ color }}>
                            {open ? 'Ocultar detalhes' : 'Ver detalhes'}
                            <svg className={`w-3.5 h-3.5 rotate-icon ${open ? 'open' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        {/* Event table */}
                        {open && (
                            <div className="mt-4 overflow-x-auto anim-up">
                                <table className="w-full text-xs">
                                    <thead>
                                        <tr className="text-left text-vp-sub border-b border-white/10">
                                            <th className="pb-2 pr-3 font-semibold">Data</th>
                                            <th className="pb-2 pr-3 font-semibold">Tipo</th>
                                            <th className="pb-2 pr-3 font-semibold">Rota</th>
                                            <th className="pb-2 pr-3 font-semibold text-right">Valor</th>
                                            <th className="pb-2 font-semibold">Obs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {events.map((ev, i) => {
                                            const tc = TYPE_CONFIG[ev.tipo] || TYPE_CONFIG.uso;
                                            return (
                                                <tr key={i} className="border-b border-white/5 hover:bg-white/[.03] transition-colors">
                                                    <td className="py-2.5 pr-3 whitespace-nowrap">{ev.data_evento || ev.data_mensagem || '‚Äî'}</td>
                                                    <td className="py-2.5 pr-3">
                                                        <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold" style={{ background: tc.bg, color: tc.color }}>
                                                            {tc.emoji} {tc.label}
                                                        </span>
                                                    </td>
                                                    <td className="py-2.5 pr-3 text-white/70">{ev.rota || '‚Äî'}</td>
                                                    <td className="py-2.5 pr-3 text-right font-semibold whitespace-nowrap" style={{ color: tc.color }}>
                                                        R$ {(ev.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                                    </td>
                                                    <td className="py-2.5 text-white/50 max-w-[180px] truncate">{ev.observacao || ev.descricao || '‚Äî'}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        /* ‚îÄ‚îÄ‚îÄ Build VP summaries ‚îÄ‚îÄ‚îÄ */
        function buildVPData(events) {
            const vpMap = {};
            events.forEach(ev => {
                const name = ev.vp || 'Desconhecido';
                if (!vpMap[name]) vpMap[name] = [];
                vpMap[name].push(ev);
            });
            return vpMap;
        }

        /* ‚îÄ‚îÄ‚îÄ Excel generator ‚îÄ‚îÄ‚îÄ */
        function genExcel(events, vpMap) {
            const wb = XLSX.utils.book_new();

            /* Aba 1 ‚Äî Dashboard */
            const dashData = [['VP', 'Or√ßado', 'Gasto', 'Dispon√≠vel', '% Utilizado', 'Status']];
            let tOrc = 0, tGas = 0, tDisp = 0;
            Object.keys(vpMap).forEach(vp => {
                const evs = vpMap[vp];
                const saldoEvs = evs.filter(e => e.tipo === 'saldo');
                let g, d;
                if (saldoEvs.length > 0) { d = saldoEvs[saldoEvs.length - 1].valor; g = BUDGET - d; }
                else {
                    const uso = evs.filter(e => e.tipo === 'uso' || e.tipo === 'cancelamento').reduce((s, e) => s + Math.abs(e.valor || 0), 0);
                    const reimb = evs.filter(e => e.tipo === 'reembolso').reduce((s, e) => s + Math.abs(e.valor || 0), 0); g = uso - reimb; d = BUDGET - g;
                }
                if (g < 0) g = 0; if (d < 0) d = 0;
                const p = Math.round((g / BUDGET) * 100);
                const st = p > 90 ? 'CR√çTICO' : p >= 70 ? 'ATEN√á√ÉO' : 'NORMAL';
                dashData.push([vp, BUDGET, g, d, p + '%', st]);
                tOrc += BUDGET; tGas += g; tDisp += d;
            });
            dashData.push(['TOTAL', tOrc, tGas, tDisp, Math.round((tGas / tOrc) * 100) + '%', '']);
            const ws1 = XLSX.utils.aoa_to_sheet(dashData);
            ws1['!cols'] = [{ wch: 24 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'üìä Dashboard');

            /* Aba 2 ‚Äî Eventos */
            const evData = [['VP', 'Data Mensagem', 'Data Evento', 'Tipo', 'Rota', 'Valor', 'Descri√ß√£o', 'Observa√ß√£o']];
            events.forEach(e => evData.push([e.vp, e.data_mensagem || '', e.data_evento || '', e.tipo, e.rota || '', e.valor || 0, e.descricao || '', e.observacao || '']));
            const ws2 = XLSX.utils.aoa_to_sheet(evData);
            ws2['!cols'] = [{ wch: 22 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 18 }, { wch: 12 }, { wch: 36 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'üìã Eventos');

            /* Aba 3 ‚Äî Por M√™s */
            const monthMap = {};
            events.forEach(e => {
                if (!e.valor || e.tipo === 'saldo') return;
                const dateStr = e.data_evento || e.data_mensagem || '';
                const parts = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
                const month = parts ? `${parts[2]}/${parts[3]}` : 'Desconhecido';
                const key = `${e.vp}|||${month}`;
                monthMap[key] = (monthMap[key] || 0) + Math.abs(e.valor);
            });
            const mData = [['VP', 'M√™s/Ano', 'Total Gasto']];
            Object.keys(monthMap).sort().forEach(k => { const [vp, m] = k.split('|||'); mData.push([vp, m, monthMap[k]]) });
            const ws3 = XLSX.utils.aoa_to_sheet(mData);
            ws3['!cols'] = [{ wch: 24 }, { wch: 12 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, ws3, 'üìÖ Por M√™s');

            return wb;
        }

        /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
        function App() {
            const [screen, setScreen] = useState('upload'); // upload | processing | dashboard | error
            const [file, setFile] = useState(null);
            const [dragging, setDragging] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('claude_api_key') || '');
            const [progress, setProgress] = useState(0);
            const [progressMsg, setProgressMsg] = useState('');
            const [events, setEvents] = useState([]);
            const [errorMsg, setErrorMsg] = useState('');
            const [toast, setToast] = useState(false);
            const fileRef = useRef(null);

            /* Save API key */
            useEffect(() => { if (apiKey) localStorage.setItem('claude_api_key', apiKey) }, [apiKey]);

            /* VP map */
            const vpMap = useMemo(() => buildVPData(events), [events]);
            const vpNames = Object.keys(vpMap);

            /* Summary stats */
            const summary = useMemo(() => {
                let tOrc = 0, tGas = 0, tDisp = 0;
                vpNames.forEach(vp => {
                    const evs = vpMap[vp];
                    const saldoEvs = evs.filter(e => e.tipo === 'saldo');
                    let g, d;
                    if (saldoEvs.length > 0) { d = saldoEvs[saldoEvs.length - 1].valor; g = BUDGET - d; }
                    else {
                        const uso = evs.filter(e => e.tipo === 'uso' || e.tipo === 'cancelamento').reduce((s, e) => s + Math.abs(e.valor || 0), 0);
                        const reimb = evs.filter(e => e.tipo === 'reembolso').reduce((s, e) => s + Math.abs(e.valor || 0), 0); g = uso - reimb; d = BUDGET - g;
                    }
                    if (g < 0) g = 0; if (d < 0) d = 0;
                    tOrc += BUDGET; tGas += g; tDisp += d;
                });
                return { vpCount: vpNames.length, orcado: tOrc, gasto: tGas, disponivel: tDisp };
            }, [vpMap, vpNames]);

            /* D&D */
            const onDragOver = useCallback(e => { e.preventDefault(); setDragging(true) }, []);
            const onDragLeave = useCallback(e => { e.preventDefault(); setDragging(false) }, []);
            const onDrop = useCallback(e => {
                e.preventDefault(); setDragging(false);
                const f = e.dataTransfer.files[0];
                if (f && f.name.endsWith('.txt')) { setFile(f); setErrorMsg('') }
                else { setErrorMsg('Selecione um arquivo .txt exportado do WhatsApp.') }
            }, []);
            const onFileSelect = useCallback(e => {
                const f = e.target.files[0];
                if (f && f.name.endsWith('.txt')) { setFile(f); setErrorMsg('') }
                else if (f) { setErrorMsg('Selecione um arquivo .txt exportado do WhatsApp.') }
            }, []);

            /* Process with Claude */
            const handleAnalyze = useCallback(async () => {
                if (!file) return;
                if (!apiKey.trim()) { setErrorMsg('Insira sua chave da API Anthropic (Claude).'); return; }

                setScreen('processing'); setProgress(5); setProgressMsg('Lendo arquivo...');

                try {
                    const text = await file.text();
                    setProgress(15); setProgressMsg('Enviando para IA...');

                    const systemPrompt = `Voc√™ √© um assistente especializado em finan√ßas corporativas.

Analise a conversa do WhatsApp abaixo e extraia TODOS os eventos relacionados ao benef√≠cio de viagens dos VPs.

Cada VP tem um or√ßamento anual de R$60.000,00.

Para cada evento encontrado, retorne um JSON com os campos abaixo.
Retorne APENAS um array JSON v√°lido, sem texto adicional, sem markdown, sem blocos de c√≥digo.

Campos do JSON:
- "vp": string (Nome do VP identificado na conversa)
- "tipo": string (um de: "uso", "saldo", "reembolso", "cancelamento")
- "descricao": string (descri√ß√£o do evento)
- "rota": string ou null (origem-destino)
- "data_evento": string ou null (data da viagem/uso no formato DD/MM/AAAA)
- "data_mensagem": string (data da mensagem no WhatsApp no formato DD/MM/AAAA)
- "valor": number (valor em reais, sem ponto de milhar)
- "observacao": string (detalhes adicionais relevantes)

Regras:
1. Identifique corretamente a qual VP cada mensagem se refere
2. Classifique o tipo do evento corretamente
3. Extraia valores monet√°rios com precis√£o
4. Se uma mensagem informar o saldo dispon√≠vel de um VP, use tipo "saldo" e o valor √© o saldo informado
5. Se n√£o encontrar eventos, retorne um array vazio []`;

                    const body = {
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4096,
                        system: systemPrompt,
                        messages: [{ role: 'user', content: `CONVERSA DO WHATSAPP:\n\n${text}` }]
                    };

                    setProgress(30); setProgressMsg('IA interpretando mensagens...');

                    /* Simulated progress while waiting */
                    let p = 30;
                    const intv = setInterval(() => { p += Math.random() * 8 + 2; if (p > 85) p = 85; setProgress(Math.round(p)) }, 600);

                    const resp = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey.trim(),
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true',
                        },
                        body: JSON.stringify(body),
                    });

                    clearInterval(intv);

                    if (!resp.ok) {
                        const errBody = await resp.text();
                        throw new Error(`API retornou ${resp.status}: ${errBody.slice(0, 200)}`);
                    }

                    setProgress(90); setProgressMsg('Processando resultado...');

                    const data = await resp.json();
                    const content = data.content?.[0]?.text || '[]';

                    /* Extract JSON from response (handle possible markdown wrapping) */
                    let jsonStr = content.trim();
                    const jsonMatch = jsonStr.match(/\[[\s\S]*\]/);
                    if (jsonMatch) jsonStr = jsonMatch[0];

                    const parsed = JSON.parse(jsonStr);

                    if (!Array.isArray(parsed)) { throw new Error('A IA n√£o retornou um array de eventos v√°lido.') }

                    /* Normalize values */
                    const normalized = parsed.map(e => ({
                        ...e,
                        valor: typeof e.valor === 'number' ? e.valor : parseFloat(String(e.valor || '0').replace(/[^\d.,-]/g, '').replace(',', '.')) || 0,
                        tipo: ['uso', 'saldo', 'reembolso', 'cancelamento'].includes(e.tipo) ? e.tipo : 'uso',
                    }));

                    setProgress(100); setProgressMsg('Conclu√≠do!');
                    setEvents(normalized);
                    setTimeout(() => setScreen('dashboard'), 500);

                } catch (err) {
                    setErrorMsg('Erro: ' + err.message);
                    setScreen('upload');
                }
            }, [file, apiKey]);

            /* Excel download */
            const handleExcel = useCallback(() => {
                const wb = genExcel(events, vpMap);
                XLSX.writeFile(wb, 'VP_Benefit_Tracker.xlsx');
                setToast(true);
            }, [events, vpMap]);

            /* Reset */
            const handleReset = useCallback(() => {
                setScreen('upload'); setFile(null); setEvents([]); setErrorMsg(''); setProgress(0);
                if (fileRef.current) fileRef.current.value = '';
            }, []);

            /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
            return (
                <div className="min-h-screen flex flex-col font-inter">
                    {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
                    <header className="w-full px-4 sm:px-6 py-4 flex items-center justify-between border-b border-white/5" style={{ background: 'linear-gradient(135deg,#0F1923,#1A2535)' }}>
                        <div className="flex items-center gap-3">
                            <span className="text-2xl sm:text-3xl">üíº</span>
                            <h1 className="text-lg sm:text-xl font-bold text-white tracking-tight">VP Benefit Tracker</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            {screen === 'dashboard' && (
                                <>
                                    <button onClick={handleExcel} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-vp-excel/20 text-green-300 border border-vp-excel/30 hover:bg-vp-excel/40 transition-colors">
                                        üìó Exportar Excel
                                    </button>
                                    <button onClick={handleReset} className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-semibold bg-white/5 text-vp-sub border border-white/10 hover:bg-white/10 transition-colors">
                                        üîÑ Novo
                                    </button>
                                </>
                            )}
                            <div className="bg-vp-teal/20 rounded-full px-2.5 py-1 ml-1">
                                <span className="text-[10px] font-semibold text-vp-teal">v1.0</span>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 px-4 py-6 sm:py-10 max-w-5xl mx-auto w-full">

                        {/* ‚ïê‚ïê‚ïê UPLOAD SCREEN ‚ïê‚ïê‚ïê */}
                        {screen === 'upload' && (
                            <div className="max-w-2xl mx-auto anim-up">


                                {/* API Key */}
                                <div className="mb-6 glass rounded-xl p-4">
                                    <label className="flex items-center gap-2 text-xs font-semibold text-vp-sub mb-2">
                                        üîë Chave da API Anthropic (Claude)
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={e => setApiKey(e.target.value)}
                                        placeholder="sk-ant-api03-..."
                                        className="w-full bg-vp-bg border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white placeholder:text-vp-sub/50 focus:outline-none focus:border-vp-teal/50 transition-colors"
                                        id="api-key-input"
                                    />
                                    <p className="text-[10px] text-vp-sub/60 mt-1.5">Armazenada apenas localmente no seu navegador.</p>
                                </div>

                                {/* Drop zone */}
                                <div className={`drop-border w-full mb-5 ${dragging ? 'dragging' : ''}`}>
                                    <div
                                        onClick={() => fileRef.current?.click()}
                                        onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={onDrop}
                                        className={`w-full rounded-xl cursor-pointer transition-all duration-300 flex flex-col items-center justify-center py-14 gap-3 ${dragging ? 'bg-vp-green/10' : file ? 'bg-vp-card' : 'bg-vp-card hover:bg-vp-card/80'}`}
                                        id="drop-zone"
                                    >
                                        <input type="file" ref={fileRef} accept=".txt" className="hidden" onChange={onFileSelect} id="file-input" />
                                        {file ? (
                                            <>
                                                <span className="text-4xl">‚úÖ</span>
                                                <p className="text-white font-semibold text-lg">{file.name}</p>
                                                <p className="text-vp-sub text-sm">{(file.size / 1024).toFixed(1)} KB ¬∑ Pronto para an√°lise</p>
                                            </>
                                        ) : (
                                            <>
                                                <span className="text-4xl">üìÅ</span>
                                                <p className="text-white font-semibold text-lg text-center">Arraste o <span className="text-vp-green">.txt</span> do WhatsApp aqui</p>
                                                <p className="text-vp-sub text-sm">ou clique para selecionar</p>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* Error */}
                                {errorMsg && (
                                    <div className="mb-5 rounded-xl p-4 flex items-start gap-3 anim-up" style={{ background: 'rgba(239,68,68,.1)', border: '1px solid rgba(239,68,68,.3)' }}>
                                        <span className="text-lg mt-0.5">‚ö†Ô∏è</span>
                                        <p className="text-red-400 font-semibold text-sm flex-1">{errorMsg}</p>
                                    </div>
                                )}

                                {/* Hint */}
                                <div className="flex items-start gap-2 mb-5 px-1">
                                    <span className="text-sm mt-0.5">‚ÑπÔ∏è</span>
                                    <p className="text-vp-sub text-xs leading-relaxed">
                                        A IA vai interpretar a conversa e identificar automaticamente os <span className="text-white font-medium">gastos</span>, <span className="text-white font-medium">saldos</span>, <span className="text-white font-medium">reembolsos</span> e <span className="text-white font-medium">cancelamentos</span> de cada benefici√°rio.
                                    </p>
                                </div>

                                {/* Analyze button */}
                                <div className="flex justify-center">
                                    <button
                                        onClick={handleAnalyze}
                                        disabled={!file}
                                        className={`px-10 py-3.5 rounded-full font-bold text-base transition-all duration-300 flex items-center gap-2 ${file ? 'text-white hover:scale-105 active:scale-95' : 'text-white/30 cursor-not-allowed'}`}
                                        style={{ background: file ? 'linear-gradient(135deg,#25D366,#128C7E)' : 'rgba(255,255,255,.06)' }}
                                        id="analyze-btn"
                                    >
                                        üîç Analisar Conversa com IA
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* ‚ïê‚ïê‚ïê PROCESSING SCREEN ‚ïê‚ïê‚ïê */}
                        {screen === 'processing' && (
                            <div className="max-w-lg mx-auto text-center anim-up py-12">
                                <div className="text-6xl mb-6">üß†</div>
                                <h2 className="text-xl font-bold text-white mb-2">Analisando com IA...</h2>
                                <p className="text-vp-sub text-sm mb-8">{progressMsg}</p>
                                <div className="w-full h-3 rounded-full overflow-hidden bg-vp-card mb-3">
                                    <div className="h-full rounded-full relative shimmer transition-all duration-300" style={{ width: `${progress}%`, background: 'linear-gradient(90deg,#075E54,#25D366)' }} />
                                </div>
                                <p className="text-vp-green text-sm font-bold">{progress}%</p>
                            </div>
                        )}

                        {/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */}
                        {screen === 'dashboard' && (
                            <div className="anim-up">
                                {/* Summary cards */}
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-8">
                                    {[
                                        { label: 'VPs Ativos', value: summary.vpCount, icon: 'üë•', color: '#3B82F6', fmt: false },
                                        { label: 'Total Or√ßado', value: summary.orcado, icon: 'üí∞', color: '#25D366', fmt: true },
                                        { label: 'Total Gasto', value: summary.gasto, icon: 'üìä', color: '#F59E0B', fmt: true },
                                        { label: 'Total Dispon√≠vel', value: summary.disponivel, icon: '‚úÖ', color: summary.disponivel < summary.orcado * 0.1 ? '#EF4444' : '#25D366', fmt: true },
                                    ].map((c, i) => (
                                        <div key={i} className="glass rounded-xl p-4 sm:p-5 text-center anim-up" style={{ animationDelay: `${i * 0.08}s` }}>
                                            <span className="text-2xl">{c.icon}</span>
                                            <p className="text-xl sm:text-2xl font-extrabold mt-2" style={{ color: c.color }}>
                                                {c.fmt ? `R$ ${c.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : c.value}
                                            </p>
                                            <p className="text-vp-sub text-[10px] font-semibold uppercase tracking-wider mt-1">{c.label}</p>
                                        </div>
                                    ))}
                                </div>

                                {/* VP Cards */}
                                <h2 className="text-sm font-bold text-vp-sub uppercase tracking-wider mb-4">üìã Detalhamento por VP</h2>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5">
                                    {vpNames.map((vp, i) => (
                                        <VPCard key={vp} vp={vp} events={vpMap[vp]} colorIdx={i} />
                                    ))}
                                </div>

                                {/* Download button (bottom) */}
                                <div className="flex justify-center mt-8">
                                    <button onClick={handleExcel} className="pulse-green px-10 py-4 rounded-full font-bold text-lg text-white flex items-center gap-2 transition-all duration-300 hover:scale-105 active:scale-95" style={{ background: 'linear-gradient(135deg,#25D366,#1D6F42)' }} id="download-btn">
                                        ‚¨áÔ∏è Baixar Relat√≥rio Excel
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="w-full px-4 py-4 text-center border-t border-white/5">
                        <p className="text-vp-sub text-xs">100% no browser ¬∑ Dados processados pela IA e nunca armazenados ¬∑ üîí</p>
                    </footer>

                    <Toast msg="Excel baixado com sucesso!" visible={toast} onHide={() => setToast(false)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>