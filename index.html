<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>VP Benefit Tracker ‚Äî Controle de Benef√≠cio de Viagens</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { 'vp-bg': '#0F1923', 'vp-card': '#1A2535', 'vp-green': '#25D366', 'vp-green-dark': '#075E54', 'vp-teal': '#128C7E', 'vp-sub': '#8A9BB0', 'vp-warn': '#F59E0B', 'vp-danger': '#EF4444', 'vp-excel': '#1D6F42' }, fontFamily: { inter: ['Inter', 'Segoe UI', 'sans-serif'] } } } }</script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box
        }

        body {
            margin: 0;
            padding: 0;
            background: #0F1923;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: #FFF;
            min-height: 100vh;
            overflow-x: hidden
        }

        @keyframes borderDash {
            0% {
                background-position: 0 0, 100% 0, 100% 100%, 0 100%
            }

            100% {
                background-position: 100% 0, 100% 100%, 0 100%, 0 0
            }
        }

        .drop-border {
            background-image: linear-gradient(90deg, #25D366 50%, transparent 50%), linear-gradient(0deg, #25D366 50%, transparent 50%), linear-gradient(90deg, #25D366 50%, transparent 50%), linear-gradient(0deg, #25D366 50%, transparent 50%);
            background-size: 20px 2px, 2px 20px, 20px 2px, 2px 20px;
            background-position: 0 0, 100% 0, 100% 100%, 0 100%;
            background-repeat: no-repeat;
            animation: borderDash 8s linear infinite;
            padding: 2px;
            border-radius: 14px
        }

        .drop-border.dragging {
            animation: borderDash 1s linear infinite
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%)
            }

            100% {
                transform: translateX(100%)
            }
        }

        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .25), transparent);
            animation: shimmer 1.5s infinite
        }

        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(24px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .anim-up {
            animation: fadeUp .5s ease-out forwards
        }

        @keyframes pulseGreen {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, .4)
            }

            50% {
                box-shadow: 0 0 0 12px rgba(37, 211, 102, 0)
            }
        }

        .pulse-green {
            animation: pulseGreen 2.5s infinite
        }

        @keyframes pulseDanger {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, .4)
            }

            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0)
            }
        }

        .pulse-danger {
            animation: pulseDanger 2s infinite
        }

        @keyframes toastIn {
            0% {
                transform: translateX(120%);
                opacity: 0
            }

            100% {
                transform: translateX(0);
                opacity: 1
            }
        }

        @keyframes toastOut {
            0% {
                transform: translateX(0);
                opacity: 1
            }

            100% {
                transform: translateX(120%);
                opacity: 0
            }
        }

        .toast-in {
            animation: toastIn .4s ease-out forwards
        }

        .toast-out {
            animation: toastOut .4s ease-in forwards
        }

        .glass {
            background: rgba(26, 37, 53, .7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(37, 211, 102, .1)
        }

        ::-webkit-scrollbar {
            width: 6px
        }

        ::-webkit-scrollbar-track {
            background: #0F1923
        }

        ::-webkit-scrollbar-thumb {
            background: #128C7E;
            border-radius: 3px
        }

        .rotate-icon {
            transition: transform .3s ease
        }

        .rotate-icon.open {
            transform: rotate(180deg)
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect, useMemo } = React;
        const BUDGET = 60000;
        const VP_COLORS = ['#25D366', '#3B82F6', '#F59E0B', '#8B5CF6', '#F97316', '#EC4899', '#14B8A6', '#6366F1'];
        const TYPE_CFG = {
            uso: { emoji: 'üü¢', label: 'Uso', color: '#25D366', bg: 'rgba(37,211,102,.12)' },
            saldo: { emoji: 'üîµ', label: 'Saldo', color: '#3B82F6', bg: 'rgba(59,130,246,.12)' },
            reembolso: { emoji: 'üü°', label: 'Reembolso', color: '#F59E0B', bg: 'rgba(245,158,11,.12)' },
            cancelamento: { emoji: 'üî¥', label: 'Cancelamento', color: '#EF4444', bg: 'rgba(239,68,68,.12)' },
        };

        const PROVIDERS = [
            { id: 'gemini', name: 'Google Gemini', placeholder: 'AIzaSy...', icon: 'üü¢', hint: 'Gr√°tis em console.cloud.google.com' },
            { id: 'openai', name: 'OpenAI (ChatGPT)', placeholder: 'sk-proj-...', icon: 'üü£', hint: 'platform.openai.com' },
            { id: 'claude', name: 'Anthropic (Claude)', placeholder: 'sk-ant-api03-...', icon: 'üü†', hint: 'console.anthropic.com' },
            { id: 'deepseek', name: 'DeepSeek', placeholder: 'sk-...', icon: 'üîµ', hint: 'platform.deepseek.com' },
        ];

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WHATSAPP PARSER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function parseWhatsApp(text) {
            const lines = text.split('\n');
            const re = /(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s(\d{1,2}:\d{2})(?:\s?[APap][Mm])?\s?-\s([^:]+):\s(.+)/;
            const msgs = [];
            for (const line of lines) {
                const m = line.match(re);
                if (m) msgs.push({ data: m[1], hora: m[2], autor: m[3].trim(), mensagem: m[4] });
                else if (msgs.length > 0 && line.trim()) msgs[msgs.length - 1].mensagem += '\n' + line;
            }
            return msgs;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SMART REGEX PARSER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function smartParse(whatsappMsgs) {
            const events = [];
            const valorRe = /R\$\s*([\d]{1,3}(?:[\.\s]?\d{3})*(?:[,]\d{1,2})?)/g;
            const saldoKw = /saldo|dispon[i√≠]vel/i;
            const reembKw = /reembolso|reembols/i;
            const cancelKw = /cancel|multa/i;
            const rotaRe = /\b([A-Z]{3})\s*[-\/]\s*([A-Z]{3})\b/;
            /* Name patterns: "do/da/VP/para Nome Sobrenome" */
            const nomeRe = /(?:d[oae]|para|VP|vice|diretor[a]?)\s+([A-Z√Ä-√ö][a-z√°√©√≠√≥√∫√£√µ√¢√™√Æ√¥√ª√ß]+(?:\s+[A-Z√Ä-√ö][a-z√°√©√≠√≥√∫√£√µ√¢√™√Æ√¥√ª√ß]+)+)/g;

            /* First pass: collect all known names from messages */
            const knownNames = new Set();
            whatsappMsgs.forEach(msg => {
                let nm;
                const nomeLocal = new RegExp(nomeRe.source, 'g');
                while ((nm = nomeLocal.exec(msg.mensagem)) !== null) {
                    knownNames.add(nm[1].trim());
                }
            });

            /* Second pass: extract events */
            let lastKnownName = null;
            whatsappMsgs.forEach(msg => {
                const txt = msg.mensagem;
                const valores = [...txt.matchAll(new RegExp(valorRe.source, 'g'))];
                if (valores.length === 0) return;

                /* Find name in this message */
                let nome = null;
                const nomeLocal2 = new RegExp(nomeRe.source, 'g');
                let nm2;
                while ((nm2 = nomeLocal2.exec(txt)) !== null) { nome = nm2[1].trim(); break; }
                if (!nome) {
                    /* Try to find any known name mentioned */
                    for (const kn of knownNames) { if (txt.includes(kn)) { nome = kn; break; } }
                }
                if (nome) lastKnownName = nome;
                if (!nome) nome = lastKnownName;

                /* Determine type */
                let tipo = 'uso';
                if (saldoKw.test(txt)) tipo = 'saldo';
                else if (reembKw.test(txt)) tipo = 'reembolso';
                else if (cancelKw.test(txt)) tipo = 'cancelamento';

                /* Route */
                const rotaM = txt.match(rotaRe);
                const rota = rotaM ? `${rotaM[1]}-${rotaM[2]}` : null;

                /* Date event: look for dates in message content */
                const dateInMsg = txt.match(/(\d{1,2}\/\d{1,2}(?:\/\d{2,4})?)/);
                const dataEvento = dateInMsg ? dateInMsg[1] : null;

                valores.forEach(v => {
                    const valStr = v[1].replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
                    const valor = parseFloat(valStr) || 0;
                    if (valor < 10) return; /* Ignore tiny values */
                    events.push({
                        vp: nome || 'N√£o identificado',
                        tipo,
                        descricao: txt.substring(0, 120).replace(/\n/g, ' '),
                        rota,
                        data_evento: dataEvento,
                        data_mensagem: msg.data,
                        valor,
                        observacao: `Mensagem de ${msg.autor}`
                    });
                });
            });
            return events;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LLM SYSTEM PROMPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        const SYS_PROMPT = `Voc√™ √© um assistente especializado em finan√ßas corporativas.
Analise a conversa do WhatsApp e extraia TODOS os eventos de benef√≠cio de viagens.
Cada benefici√°rio tem or√ßamento anual de R$60.000,00.
Retorne APENAS um array JSON v√°lido, sem texto, sem markdown.
Campos: "vp" (nome), "tipo" ("uso"|"saldo"|"reembolso"|"cancelamento"), "descricao", "rota" (ou null), "data_evento" (DD/MM/AAAA ou null), "data_mensagem" (DD/MM/AAAA), "valor" (number), "observacao".
Regras: 1)Identifique o benefici√°rio correto 2)Classifique tipo corretamente 3)Extraia valores com precis√£o 4)Saldo=valor dispon√≠vel informado 5)Array vazio se nada encontrado`;

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LLM CALLERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        async function callGemini(key, text) {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ system_instruction: { parts: [{ text: SYS_PROMPT }] }, contents: [{ parts: [{ text: `CONVERSA:\n${text}` }] }] })
            });
            if (!r.ok) throw new Error(`Gemini ${r.status}: ${(await r.text()).slice(0, 200)}`);
            const d = await r.json();
            return d.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
        }

        async function callOpenAI(key, text) {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: SYS_PROMPT }, { role: 'user', content: `CONVERSA:\n${text}` }], temperature: 0.1 })
            });
            if (!r.ok) throw new Error(`OpenAI ${r.status}: ${(await r.text()).slice(0, 200)}`);
            const d = await r.json();
            return d.choices?.[0]?.message?.content || '[]';
        }

        async function callClaude(key, text) {
            const r = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 4096, system: SYS_PROMPT, messages: [{ role: 'user', content: `CONVERSA:\n${text}` }] })
            });
            if (!r.ok) throw new Error(`Claude ${r.status}: ${(await r.text()).slice(0, 200)}`);
            const d = await r.json();
            return d.content?.[0]?.text || '[]';
        }

        async function callDeepSeek(key, text) {
            const r = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'system', content: SYS_PROMPT }, { role: 'user', content: `CONVERSA:\n${text}` }], temperature: 0.1 })
            });
            if (!r.ok) throw new Error(`DeepSeek ${r.status}: ${(await r.text()).slice(0, 200)}`);
            const d = await r.json();
            return d.choices?.[0]?.message?.content || '[]';
        }

        async function callLLM(provider, key, text) {
            const callers = { gemini: callGemini, openai: callOpenAI, claude: callClaude, deepseek: callDeepSeek };
            const raw = await callers[provider](key, text);
            let j = raw.trim();
            const m = j.match(/\[[\s\S]*\]/);
            if (m) j = m[0];
            const parsed = JSON.parse(j);
            if (!Array.isArray(parsed)) throw new Error('IA n√£o retornou array v√°lido');
            return parsed.map(e => ({
                ...e,
                valor: typeof e.valor === 'number' ? e.valor : parseFloat(String(e.valor || '0').replace(/[^\d.,-]/g, '').replace(',', '.')) || 0,
                tipo: ['uso', 'saldo', 'reembolso', 'cancelamento'].includes(e.tipo) ? e.tipo : 'uso',
            }));
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPONENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function Toast({ msg, visible, onHide }) {
            const [leaving, setLeaving] = useState(false);
            useEffect(() => { if (visible) { setLeaving(false); const t = setTimeout(() => { setLeaving(true); setTimeout(onHide, 400) }, 3000); return () => clearTimeout(t) } }, [visible, onHide]);
            if (!visible && !leaving) return null;
            return <div className={`fixed bottom-6 right-6 z-50 flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl ${leaving ? 'toast-out' : 'toast-in'}`} style={{ background: 'linear-gradient(135deg,#1D6F42,#25D366)' }}><span className="text-xl">‚úÖ</span><span className="text-white font-semibold text-sm">{msg}</span></div>;
        }

        function StatusBadge({ pct }) {
            if (pct > 90) return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-500/20 text-red-400 border border-red-500/30">üö® Cr√≠tico</span>;
            if (pct >= 70) return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">‚ö†Ô∏è Aten√ß√£o</span>;
            return <span className="px-2.5 py-1 rounded-full text-[10px] font-bold bg-green-500/20 text-green-400 border border-green-500/30">‚úÖ Normal</span>;
        }

        function UsageBar({ pct }) {
            const c = Math.min(pct, 100); const color = pct > 90 ? '#EF4444' : pct >= 70 ? '#F59E0B' : '#25D366';
            return <div className="w-full h-3 rounded-full overflow-hidden bg-white/5 mt-2"><div className="h-full rounded-full transition-all duration-700 relative" style={{ width: `${c}%`, background: color }}>{pct > 90 && <div className="absolute inset-0 rounded-full pulse-danger" style={{ background: color }} />}</div></div>;
        }

        function calcFinancials(events) {
            const saldoEvs = events.filter(e => e.tipo === 'saldo');
            const usoEvs = events.filter(e => e.tipo === 'uso' || e.tipo === 'cancelamento');
            const reimbEvs = events.filter(e => e.tipo === 'reembolso');
            let gasto, disponivel;
            if (saldoEvs.length > 0) { disponivel = saldoEvs[saldoEvs.length - 1].valor; gasto = BUDGET - disponivel; }
            else { const u = usoEvs.reduce((s, e) => s + Math.abs(e.valor || 0), 0); const r = reimbEvs.reduce((s, e) => s + Math.abs(e.valor || 0), 0); gasto = u - r; disponivel = BUDGET - gasto; }
            if (gasto < 0) gasto = 0; if (disponivel < 0) disponivel = 0;
            return { gasto, disponivel, pct: Math.round((gasto / BUDGET) * 100) };
        }

        function VPCard({ vp, events, colorIdx }) {
            const [open, setOpen] = useState(false);
            const color = VP_COLORS[colorIdx % VP_COLORS.length];
            const { gasto, disponivel, pct } = calcFinancials(events);
            const isCritical = disponivel < 5000;
            return (
                <div className={`glass rounded-2xl overflow-hidden shadow-xl anim-up`} style={{ animationDelay: `${colorIdx * 0.1}s`, borderColor: isCritical ? 'rgba(239,68,68,.4)' : 'rgba(255,255,255,.06)' }}>
                    <div className="h-1" style={{ background: `linear-gradient(90deg,${color},${color}88)` }} />
                    <div className="p-5 sm:p-6">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" style={{ background: color + '22', color }}>{vp.charAt(0).toUpperCase()}</div>
                                <div><h3 className="text-white font-bold text-base">{vp}</h3><p className="text-vp-sub text-xs">{events.length} evento{events.length !== 1 ? 's' : ''}</p></div>
                            </div>
                            <StatusBadge pct={pct} />
                        </div>
                        <div className="grid grid-cols-3 gap-3 mb-3">
                            <div className="bg-white/5 rounded-lg p-3 text-center"><p className="text-[10px] text-vp-sub font-semibold uppercase">Or√ßado</p><p className="text-sm font-bold text-white mt-1">R$ {BUDGET.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p></div>
                            <div className="bg-white/5 rounded-lg p-3 text-center"><p className="text-[10px] text-vp-sub font-semibold uppercase">Gasto</p><p className="text-sm font-bold mt-1" style={{ color }}>R$ {gasto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p></div>
                            <div className={`rounded-lg p-3 text-center ${isCritical ? 'bg-red-500/10' : 'bg-white/5'}`}><p className="text-[10px] text-vp-sub font-semibold uppercase">Dispon√≠vel</p><p className={`text-sm font-bold mt-1 ${isCritical ? 'text-red-400' : 'text-green-400'}`}>R$ {disponivel.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p></div>
                        </div>
                        <div className="flex items-center justify-between text-xs text-vp-sub"><span>{pct}% utilizado</span>{isCritical && <span className="text-red-400 font-semibold">‚ö† Saldo baixo</span>}</div>
                        <UsageBar pct={pct} />
                        {events.length > 0 && <p className="text-vp-sub text-xs mt-3 truncate">√öltima mov.: <span className="text-white/80">{events[events.length - 1].descricao}</span></p>}
                        <button onClick={() => setOpen(!open)} className="mt-4 flex items-center gap-1.5 text-xs font-semibold transition-colors hover:text-vp-green" style={{ color }}>
                            {open ? 'Ocultar detalhes' : 'Ver detalhes'}
                            <svg className={`w-3.5 h-3.5 rotate-icon ${open ? 'open' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        {open && (
                            <div className="mt-4 overflow-x-auto anim-up">
                                <table className="w-full text-xs"><thead><tr className="text-left text-vp-sub border-b border-white/10">
                                    <th className="pb-2 pr-3 font-semibold">Data</th><th className="pb-2 pr-3 font-semibold">Tipo</th><th className="pb-2 pr-3 font-semibold">Rota</th><th className="pb-2 pr-3 font-semibold text-right">Valor</th><th className="pb-2 font-semibold">Obs</th>
                                </tr></thead><tbody>
                                        {events.map((ev, i) => {
                                            const tc = TYPE_CFG[ev.tipo] || TYPE_CFG.uso; return (
                                                <tr key={i} className="border-b border-white/5 hover:bg-white/[.03] transition-colors">
                                                    <td className="py-2.5 pr-3 whitespace-nowrap">{ev.data_evento || ev.data_mensagem || '‚Äî'}</td>
                                                    <td className="py-2.5 pr-3"><span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold" style={{ background: tc.bg, color: tc.color }}>{tc.emoji} {tc.label}</span></td>
                                                    <td className="py-2.5 pr-3 text-white/70">{ev.rota || '‚Äî'}</td>
                                                    <td className="py-2.5 pr-3 text-right font-semibold whitespace-nowrap" style={{ color: tc.color }}>R$ {(ev.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                                    <td className="py-2.5 text-white/50 max-w-[180px] truncate">{ev.observacao || '‚Äî'}</td>
                                                </tr>);
                                        })}
                                    </tbody></table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXCEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function genExcel(events, vpMap) {
            const wb = XLSX.utils.book_new();
            const d1 = [['Benefici√°rio', 'Or√ßado', 'Gasto', 'Dispon√≠vel', '% Utilizado', 'Status']];
            let tO = 0, tG = 0, tD = 0;
            Object.keys(vpMap).forEach(vp => { const { gasto: g, disponivel: d, pct: p } = calcFinancials(vpMap[vp]); const st = p > 90 ? 'CR√çTICO' : p >= 70 ? 'ATEN√á√ÉO' : 'NORMAL'; d1.push([vp, BUDGET, g, d, p + '%', st]); tO += BUDGET; tG += g; tD += d; });
            d1.push(['TOTAL', tO, tG, tD, Math.round((tG / tO) * 100) + '%', '']);
            const ws1 = XLSX.utils.aoa_to_sheet(d1); ws1['!cols'] = [{ wch: 24 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'Dashboard');

            const d2 = [['Benefici√°rio', 'Data Msg', 'Data Evento', 'Tipo', 'Rota', 'Valor', 'Descri√ß√£o', 'Observa√ß√£o']];
            events.forEach(e => d2.push([e.vp, e.data_mensagem || '', e.data_evento || '', e.tipo, e.rota || '', e.valor || 0, e.descricao || '', e.observacao || '']));
            const ws2 = XLSX.utils.aoa_to_sheet(d2); ws2['!cols'] = [{ wch: 22 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 18 }, { wch: 12 }, { wch: 36 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Eventos');

            const mm = {}; events.forEach(e => { if (!e.valor || e.tipo === 'saldo') return; const ds = e.data_evento || e.data_mensagem || ''; const pt = ds.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/); const mo = pt ? `${pt[2]}/${pt[3]}` : '?'; const k = `${e.vp}|||${mo}`; mm[k] = (mm[k] || 0) + Math.abs(e.valor); });
            const d3 = [['Benefici√°rio', 'M√™s/Ano', 'Total Gasto']]; Object.keys(mm).sort().forEach(k => { const [v, m] = k.split('|||'); d3.push([v, m, mm[k]]); });
            const ws3 = XLSX.utils.aoa_to_sheet(d3); ws3['!cols'] = [{ wch: 24 }, { wch: 12 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, ws3, 'Por M√™s');
            return wb;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function App() {
            const [screen, setScreen] = useState('upload');
            const [file, setFile] = useState(null);
            const [rawText, setRawText] = useState('');
            const [dragging, setDragging] = useState(false);
            const [mode, setMode] = useState('regex'); // regex | llm
            const [provider, setProvider] = useState('gemini');
            const [apiKeys, setApiKeys] = useState(() => { try { return JSON.parse(localStorage.getItem('vp_api_keys') || '{}') } catch { return {} } });
            const [progress, setProgress] = useState(0);
            const [progressMsg, setProgressMsg] = useState('');
            const [events, setEvents] = useState([]);
            const [parseMethod, setParseMethod] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [toast, setToast] = useState(false);
            const fileRef = useRef(null);

            useEffect(() => { try { localStorage.setItem('vp_api_keys', JSON.stringify(apiKeys)) } catch { } }, [apiKeys]);

            const vpMap = useMemo(() => { const m = {}; events.forEach(e => { const n = e.vp || 'Desconhecido'; if (!m[n]) m[n] = []; m[n].push(e); }); return m; }, [events]);
            const vpNames = Object.keys(vpMap);

            const summary = useMemo(() => {
                let tO = 0, tG = 0, tD = 0;
                vpNames.forEach(vp => { const { gasto: g, disponivel: d } = calcFinancials(vpMap[vp]); tO += BUDGET; tG += g; tD += d; });
                return { count: vpNames.length, orcado: tO, gasto: tG, disponivel: tD };
            }, [vpMap, vpNames]);

            const onDragOver = useCallback(e => { e.preventDefault(); setDragging(true) }, []);
            const onDragLeave = useCallback(e => { e.preventDefault(); setDragging(false) }, []);
            const onDrop = useCallback(e => { e.preventDefault(); setDragging(false); const f = e.dataTransfer.files[0]; if (f && f.name.endsWith('.txt')) { setFile(f); setErrorMsg('') } else setErrorMsg('Selecione um arquivo .txt') }, []);
            const onFileSelect = useCallback(e => { const f = e.target.files[0]; if (f && f.name.endsWith('.txt')) { setFile(f); setErrorMsg('') } else if (f) setErrorMsg('Selecione um arquivo .txt') }, []);

            const handleAnalyze = useCallback(async () => {
                if (!file) return;
                setScreen('processing'); setProgress(5); setProgressMsg('Lendo arquivo...');
                try {
                    const text = await file.text();
                    setRawText(text);
                    setProgress(15);

                    if (mode === 'regex') {
                        setProgressMsg('Analisando com parser autom√°tico...');
                        let p = 15; const iv = setInterval(() => { p += 15; if (p > 90) p = 90; setProgress(p) }, 100);
                        const wpMsgs = parseWhatsApp(text);
                        if (wpMsgs.length === 0) { clearInterval(iv); throw new Error('Nenhuma mensagem WhatsApp encontrada no arquivo.'); }
                        const evts = smartParse(wpMsgs);
                        clearInterval(iv);
                        setProgress(100); setProgressMsg('Conclu√≠do!');
                        setEvents(evts); setParseMethod('Parser Autom√°tico (Regex)');
                        setTimeout(() => setScreen('dashboard'), 400);
                    } else {
                        const key = apiKeys[provider] || '';
                        if (!key.trim()) { throw new Error('Insira a API Key do provedor selecionado.'); }
                        setProgressMsg(`Enviando para ${PROVIDERS.find(p => p.id === provider)?.name}...`);
                        let p = 20; const iv = setInterval(() => { p += Math.random() * 8 + 2; if (p > 85) p = 85; setProgress(Math.round(p)) }, 600);
                        const evts = await callLLM(provider, key.trim(), text);
                        clearInterval(iv);
                        setProgress(100); setProgressMsg('Conclu√≠do!');
                        setEvents(evts); setParseMethod(PROVIDERS.find(p => p.id === provider)?.name || 'IA');
                        setTimeout(() => setScreen('dashboard'), 400);
                    }
                } catch (err) { setErrorMsg('Erro: ' + err.message); setScreen('upload'); }
            }, [file, mode, provider, apiKeys]);

            /* Re-analyze with different method */
            const handleReanalyze = useCallback(async (newMode) => {
                if (!rawText) return;
                setScreen('processing'); setProgress(10);
                try {
                    if (newMode === 'regex') {
                        setProgressMsg('Reanalisando com parser...');
                        const wpMsgs = parseWhatsApp(rawText);
                        const evts = smartParse(wpMsgs);
                        setProgress(100); setEvents(evts); setParseMethod('Parser Autom√°tico');
                        setTimeout(() => setScreen('dashboard'), 300);
                    } else {
                        const key = apiKeys[provider] || '';
                        if (!key.trim()) { setErrorMsg('Insira a API Key.'); setScreen('dashboard'); return; }
                        setProgressMsg(`Refinando com ${PROVIDERS.find(p => p.id === provider)?.name}...`);
                        let p = 10; const iv = setInterval(() => { p += Math.random() * 10 + 3; if (p > 85) p = 85; setProgress(Math.round(p)) }, 500);
                        const evts = await callLLM(provider, key.trim(), rawText);
                        clearInterval(iv);
                        setProgress(100); setEvents(evts); setParseMethod(PROVIDERS.find(p => p.id === provider)?.name);
                        setTimeout(() => setScreen('dashboard'), 300);
                    }
                } catch (err) { setErrorMsg('Erro: ' + err.message); setScreen('dashboard'); }
            }, [rawText, provider, apiKeys]);

            const handleExcel = useCallback(() => { XLSX.writeFile(genExcel(events, vpMap), 'VP_Benefit_Tracker.xlsx'); setToast(true); }, [events, vpMap]);
            const handleReset = useCallback(() => { setScreen('upload'); setFile(null); setRawText(''); setEvents([]); setErrorMsg(''); setProgress(0); if (fileRef.current) fileRef.current.value = ''; }, []);

            const currentKey = apiKeys[provider] || '';
            const setCurrentKey = k => setApiKeys(prev => ({ ...prev, [provider]: k }));
            const provInfo = PROVIDERS.find(p => p.id === provider);

            return (
                <div className="min-h-screen flex flex-col font-inter">
                    <header className="w-full px-4 sm:px-6 py-4 flex items-center justify-between border-b border-white/5" style={{ background: 'linear-gradient(135deg,#0F1923,#1A2535)' }}>
                        <div className="flex items-center gap-3"><span className="text-2xl sm:text-3xl">üíº</span><h1 className="text-lg sm:text-xl font-bold text-white tracking-tight">VP Benefit Tracker</h1></div>
                        <div className="flex items-center gap-2">
                            {screen === 'dashboard' && <>
                                <button onClick={handleExcel} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-vp-excel/20 text-green-300 border border-vp-excel/30 hover:bg-vp-excel/40 transition-colors">üìó Excel</button>
                                <button onClick={handleReset} className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-semibold bg-white/5 text-vp-sub border border-white/10 hover:bg-white/10 transition-colors">üîÑ Novo</button>
                            </>}
                            <div className="bg-vp-teal/20 rounded-full px-2.5 py-1 ml-1"><span className="text-[10px] font-semibold text-vp-teal">v2.0</span></div>
                        </div>
                    </header>

                    <main className="flex-1 px-4 py-6 sm:py-10 max-w-5xl mx-auto w-full">

                        {/* ‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê */}
                        {screen === 'upload' && (
                            <div className="max-w-2xl mx-auto anim-up">
                                {/* Mode Toggle */}
                                <div className="flex items-center justify-center mb-6">
                                    <div className="bg-vp-card rounded-xl p-1 flex gap-1 border border-white/5">
                                        <button onClick={() => setMode('regex')} className={`px-5 py-2.5 rounded-lg text-sm font-semibold transition-all ${mode === 'regex' ? 'bg-vp-green text-black' : 'text-vp-sub hover:text-white'}`}>‚ö° Parser Autom√°tico</button>
                                        <button onClick={() => setMode('llm')} className={`px-5 py-2.5 rounded-lg text-sm font-semibold transition-all ${mode === 'llm' ? 'bg-vp-teal text-white' : 'text-vp-sub hover:text-white'}`}>üß† An√°lise com IA</button>
                                    </div>
                                </div>

                                {/* LLM Config */}
                                {mode === 'llm' && (
                                    <div className="mb-6 glass rounded-xl p-4 anim-up">
                                        <label className="text-xs font-semibold text-vp-sub mb-2 block">ü§ñ Provedor de IA</label>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                                            {PROVIDERS.map(p => (
                                                <button key={p.id} onClick={() => setProvider(p.id)}
                                                    className={`px-3 py-2 rounded-lg text-xs font-semibold transition-all flex items-center gap-1.5 justify-center ${provider === p.id ? 'bg-vp-teal/30 text-white border border-vp-teal/50' : 'bg-white/5 text-vp-sub border border-white/5 hover:bg-white/10'}`}>
                                                    <span>{p.icon}</span>{p.name.split(' ')[0]}
                                                </button>
                                            ))}
                                        </div>
                                        <label className="text-xs font-semibold text-vp-sub mb-2 flex items-center gap-2">üîë API Key ‚Äî {provInfo?.name}</label>
                                        <input type="password" value={currentKey} onChange={e => setCurrentKey(e.target.value)} placeholder={provInfo?.placeholder}
                                            className="w-full bg-vp-bg border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white placeholder:text-vp-sub/40 focus:outline-none focus:border-vp-teal/50 transition-colors" />
                                        <p className="text-[10px] text-vp-sub/50 mt-1.5">{provInfo?.hint} ¬∑ Chave salva localmente no navegador</p>
                                    </div>
                                )}

                                {/* Mode info */}
                                {mode === 'regex' && (
                                    <div className="mb-6 flex items-start gap-2.5 px-1">
                                        <span className="text-lg mt-0.5">‚ö°</span>
                                        <div>
                                            <p className="text-white text-sm font-semibold mb-1">Parser Autom√°tico ‚Äî Sem IA, sem custo</p>
                                            <p className="text-vp-sub text-xs leading-relaxed">Extrai valores, nomes, rotas e tipos diretamente do texto usando padr√µes inteligentes. Funciona offline e instantaneamente.</p>
                                        </div>
                                    </div>
                                )}

                                {/* Drop zone */}
                                <div className={`drop-border w-full mb-5 ${dragging ? 'dragging' : ''}`}>
                                    <div onClick={() => fileRef.current?.click()} onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={onDrop}
                                        className={`w-full rounded-xl cursor-pointer transition-all duration-300 flex flex-col items-center justify-center py-14 gap-3 ${dragging ? 'bg-vp-green/10' : file ? 'bg-vp-card' : 'bg-vp-card hover:bg-vp-card/80'}`}>
                                        <input type="file" ref={fileRef} accept=".txt" className="hidden" onChange={onFileSelect} />
                                        {file ? <><span className="text-4xl">‚úÖ</span><p className="text-white font-semibold text-lg">{file.name}</p><p className="text-vp-sub text-sm">{(file.size / 1024).toFixed(1)} KB</p></>
                                            : <><span className="text-4xl">üìÅ</span><p className="text-white font-semibold text-lg text-center">Arraste o <span className="text-vp-green">.txt</span> do WhatsApp aqui</p><p className="text-vp-sub text-sm">ou clique para selecionar</p></>}
                                    </div>
                                </div>

                                {errorMsg && <div className="mb-5 rounded-xl p-4 flex items-start gap-3 anim-up" style={{ background: 'rgba(239,68,68,.1)', border: '1px solid rgba(239,68,68,.3)' }}><span className="text-lg">‚ö†Ô∏è</span><p className="text-red-400 font-semibold text-sm flex-1">{errorMsg}</p></div>}

                                <div className="flex items-start gap-2 mb-5 px-1"><span className="text-sm mt-0.5">‚ÑπÔ∏è</span>
                                    <p className="text-vp-sub text-xs leading-relaxed">A ferramenta identifica automaticamente <span className="text-white font-medium">gastos</span>, <span className="text-white font-medium">saldos</span>, <span className="text-white font-medium">reembolsos</span> e <span className="text-white font-medium">cancelamentos</span> de cada benefici√°rio.</p>
                                </div>

                                <div className="flex justify-center">
                                    <button onClick={handleAnalyze} disabled={!file}
                                        className={`px-10 py-3.5 rounded-full font-bold text-base transition-all duration-300 flex items-center gap-2 ${file ? 'text-white hover:scale-105 active:scale-95' : 'text-white/30 cursor-not-allowed'}`}
                                        style={{ background: file ? 'linear-gradient(135deg,#25D366,#128C7E)' : 'rgba(255,255,255,.06)' }}>
                                        {mode === 'regex' ? '‚ö° Analisar Conversa' : 'üß† Analisar com IA'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* ‚ïê‚ïê‚ïê PROCESSING ‚ïê‚ïê‚ïê */}
                        {screen === 'processing' && (
                            <div className="max-w-lg mx-auto text-center anim-up py-12">
                                <div className="text-6xl mb-6">{mode === 'regex' ? '‚ö°' : 'üß†'}</div>
                                <h2 className="text-xl font-bold text-white mb-2">{mode === 'regex' ? 'Analisando...' : 'Processando com IA...'}</h2>
                                <p className="text-vp-sub text-sm mb-8">{progressMsg}</p>
                                <div className="w-full h-3 rounded-full overflow-hidden bg-vp-card mb-3"><div className="h-full rounded-full relative shimmer transition-all duration-300" style={{ width: `${progress}%`, background: 'linear-gradient(90deg,#075E54,#25D366)' }} /></div>
                                <p className="text-vp-green text-sm font-bold">{progress}%</p>
                            </div>
                        )}

                        {/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */}
                        {screen === 'dashboard' && (
                            <div className="anim-up">
                                {/* Parse method badge */}
                                <div className="flex items-center justify-between mb-6 flex-wrap gap-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-vp-sub">An√°lise via:</span>
                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-vp-teal/20 text-vp-teal border border-vp-teal/30">{parseMethod}</span>
                                    </div>
                                    <div className="flex gap-2">
                                        {parseMethod.includes('Parser') && rawText && (
                                            <button onClick={() => {
                                                const key = apiKeys[provider] || '';
                                                if (!key) { setErrorMsg('Configure uma API Key primeiro.'); return; }
                                                handleReanalyze('llm');
                                            }} className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-vp-teal/20 text-vp-teal border border-vp-teal/30 hover:bg-vp-teal/40 transition-colors">
                                                üß† Refinar com IA
                                            </button>
                                        )}
                                        {!parseMethod.includes('Parser') && rawText && (
                                            <button onClick={() => handleReanalyze('regex')} className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-white/5 text-vp-sub border border-white/10 hover:bg-white/10 transition-colors">
                                                ‚ö° Ver com Parser
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {errorMsg && <div className="mb-4 rounded-xl p-3 flex items-center gap-2" style={{ background: 'rgba(239,68,68,.1)', border: '1px solid rgba(239,68,68,.3)' }}><span>‚ö†Ô∏è</span><p className="text-red-400 text-xs font-semibold">{errorMsg}</p></div>}

                                {/* Summary */}
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-8">
                                    {[
                                        { label: 'Benefici√°rios', value: summary.count, icon: 'üë•', color: '#3B82F6', fmt: false },
                                        { label: 'Total Or√ßado', value: summary.orcado, icon: 'üí∞', color: '#25D366', fmt: true },
                                        { label: 'Total Gasto', value: summary.gasto, icon: 'üìä', color: '#F59E0B', fmt: true },
                                        { label: 'Total Dispon√≠vel', value: summary.disponivel, icon: '‚úÖ', color: summary.disponivel < summary.orcado * 0.1 ? '#EF4444' : '#25D366', fmt: true },
                                    ].map((c, i) => (
                                        <div key={i} className="glass rounded-xl p-4 sm:p-5 text-center anim-up" style={{ animationDelay: `${i * 0.08}s` }}>
                                            <span className="text-2xl">{c.icon}</span>
                                            <p className="text-xl sm:text-2xl font-extrabold mt-2" style={{ color: c.color }}>{c.fmt ? `R$ ${c.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : c.value}</p>
                                            <p className="text-vp-sub text-[10px] font-semibold uppercase tracking-wider mt-1">{c.label}</p>
                                        </div>
                                    ))}
                                </div>

                                <h2 className="text-sm font-bold text-vp-sub uppercase tracking-wider mb-4">üìã Detalhamento por Benefici√°rio</h2>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5">
                                    {vpNames.map((vp, i) => <VPCard key={vp} vp={vp} events={vpMap[vp]} colorIdx={i} />)}
                                </div>

                                {events.length === 0 && (
                                    <div className="text-center py-12"><p className="text-vp-sub text-lg">Nenhum evento encontrado na conversa.</p><p className="text-vp-sub/60 text-sm mt-2">Tente usar a an√°lise com IA para melhor interpreta√ß√£o.</p></div>
                                )}

                                <div className="flex justify-center mt-8">
                                    <button onClick={handleExcel} className="pulse-green px-10 py-4 rounded-full font-bold text-lg text-white flex items-center gap-2 transition-all duration-300 hover:scale-105 active:scale-95" style={{ background: 'linear-gradient(135deg,#25D366,#1D6F42)' }}>‚¨áÔ∏è Baixar Relat√≥rio Excel</button>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="w-full px-4 py-4 text-center border-t border-white/5"><p className="text-vp-sub text-xs">100% no browser ¬∑ Dados nunca armazenados ¬∑ üîí</p></footer>
                    <Toast msg="Excel baixado com sucesso!" visible={toast} onHide={() => setToast(false)} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>